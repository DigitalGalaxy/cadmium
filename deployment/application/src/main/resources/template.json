{
    "AWSTemplateFormatVersion": "2010-09-09", 
    "Description": "Starts a Cadmium Instance", 
    "Outputs": {
        "URL": {
            "Description": "URL", 
            "Value": {
                "Fn::Join": [
                    "", 
                    [
                        "http://", 
                        {
                            "Ref": "Host"
                        }, 
                        "/"
                    ]
                ]
            }
        }
    }, 
    "Parameters": {
        "AvailabilityZone": {
            "Type": "String"
        }, 
        "Environment": {
            "Description": "The type of environment to create.", 
            "Type": "String"
        }, 
        "Host": {
            "Description": "The host name for the cluster.", 
            "Type": "String"
        }, 
        "KeyName": {
            "Description": "The name of the key for accessing the nodes.", 
            "Type": "String"
        }, 
        "SecurityGroup": {
            "Description": "Specify an external security group to add the nodes into.", 
            "Type": "String",
            "Default": "default"
        },
        "AWSAccessKey" : {
          "Description": "The access key that will be used during initialization of the nodes.",
          "NoEcho": "TRUE",
          "Type": "String"
        },
        "AWSSecretKey" : {
          "Description": "The secret key that will be used during initialization of the nodes.",
          "NoEcho": "TRUE",
          "Type": "String"
         }
    }, 
    "Resources": {
        "CadmiumControllerCName": {
            "Description": "The CNAME record for the domain controller.", 
            "Properties": {
                "HostedZoneId": "/hostedzone/ZCD7YP7AJKBS4", 
                "Name": {
                    "Fn::Join": [
                        "", 
                        [
                            {
                                "Ref": "Host"
                            }, 
                            "."
                        ]
                    ]
                }, 
                "ResourceRecords": [
                    {
                        "Ref": "CadmiumELB"
                    }
                ], 
                "TTL": "20", 
                "Type": "CNAME"
            }, 
            "Type": "AWS::Route53::RecordSet"
        }, 
        "CadmiumELB": {
            "Properties": {
                "AvailabilityZones": [
                    {
                        "Ref": "AvailabilityZone"
                    }
                ], 
                "HealthCheck": {
                    "HealthyThreshold": "2", 
                    "Interval": "6", 
                    "Target": "HTTP:8080/index.html", 
                    "Timeout": "5", 
                    "UnhealthyThreshold": "2"
                }, 
                "Instances": [
                    {
                        "Ref": "CadmiumNode1"
                    }, 
                    {
                        "Ref": "CadmiumNode2"
                    }
                ], 
                "Listeners": [
                    {
                        "InstancePort": "8080", 
                        "LoadBalancerPort": "80", 
                        "PolicyNames": [], 
                        "Protocol": "HTTP"
                    }
                ]
            }, 
            "Type": "AWS::ElasticLoadBalancing::LoadBalancer"
        }, 
        "CadmiumElbIngress": {
            "Properties": {
                "FromPort": "8080", 
                "GroupName": {
                    "Ref": "CadmiumSecurityGroup"
                }, 
                "IpProtocol": "tcp", 
                "SourceSecurityGroupName": {
                    "Fn::GetAtt": [
                        "CadmiumELB", 
                        "SourceSecurityGroup.GroupName"
                    ]
                }, 
                "SourceSecurityGroupOwnerId": {
                    "Fn::GetAtt": [
                        "CadmiumELB", 
                        "SourceSecurityGroup.OwnerAlias"
                    ]
                }, 
                "ToPort": "8080"
            }, 
            "Type": "AWS::EC2::SecurityGroupIngress"
        }, 
        "CadmiumNode1": {
            "Properties": {
                "AvailabilityZone": {
                    "Ref": "AvailabilityZone"
                }, 
                "DisableApiTermination": "FALSE", 
                "ImageId": "ami-0fc59d4a", 
                "InstanceType": "m1.small", 
                "KernelId": "aki-8d396bc8", 
                "KeyName": {
                    "Ref": "KeyName"
                }, 
                "Monitoring": "false", 
                "SecurityGroups": [
                    {
                        "Ref": "CadmiumSecurityGroup"
                    }, 
                    {
                        "Ref": "SecurityGroup"
                    }
                ], 
                "Tags": [
                    {
                        "Key": "Type", 
                        "Value": "Cadmium"
                    }, 
                    {
                        "Key": "Environment", 
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ], 
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "", 
                            [
                                "#!/bin/bash -ex", 
                                "\n", 
                                "apt-get update\n", 
                                "apt-get -y install python-setuptools\n", 
                                "easy_install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-1.1.tar.gz\n", 
                                "cfn-init --region ", 
                                {
                                    "Ref": "AWS::Region"
                                }, 
                                "    -s ", 
                                {
                                    "Ref": "AWS::StackName"
                                }, 
                                " -r ApplicationEC2Instance ", 
                                "         --access-key ", 
                                {
                                    "Ref": "AWSAccessKey"
                                }, 
                                "         --secret-key ", 
                                {
                                    "Ref": "AWSSecretKey"
                                }, 
                                " || error_exit 'Failed to run cfn-init'\n", 
                                "# Fixup path and links for the bootstrap script\n", 
                                "export PATH=$PATH:/var/lib/gems/1.8/bin\n", 
                                "mkdir -p /var/log/chef /var/lib/chef /var/cache/chef /var/backups/chef /var/run/chef\n", 
                                "chef-client -d -j /etc/chef/roles.json -L /var/log/chef/client.log -i 1800 -s 20 -N cadmium-`curl http://169.254.169.254/latest/meta-data/instance-id`\n"
                            ]
                        ]
                    }
                }
            }, 
            "Type": "AWS::EC2::Instance"
        }, 
        "CadmiumNode2": {
            "Properties": {
                "AvailabilityZone": {
                    "Ref": "AvailabilityZone"
                }, 
                "DisableApiTermination": "FALSE", 
                "ImageId": "ami-0fc59d4a", 
                "InstanceType": "m1.small", 
                "KernelId": "aki-8d396bc8", 
                "KeyName": {
                    "Ref": "KeyName"
                }, 
                "Monitoring": "false", 
                "SecurityGroups": [
                    {
                        "Ref": "CadmiumSecurityGroup"
                    }, 
                    {
                        "Ref": "SecurityGroup"
                    }
                ], 
                "Tags": [
                    {
                        "Key": "Type", 
                        "Value": "Cadmium"
                    }, 
                    {
                        "Key": "Environment", 
                        "Value": {
                            "Ref": "Environment"
                        }
                    }
                ],
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "",
                            [
                                "#!/bin/bash -ex",
                                "\n",
                                "apt-get update\n",
                                "apt-get -y install python-setuptools\n",
                                "easy_install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-1.1.tar.gz\n",
                                "cfn-init --region ",
                                {
                                    "Ref": "AWS::Region"
                                },
                                "    -s ",
                                {
                                    "Ref": "AWS::StackName"
                                },
                                " -r ApplicationEC2Instance ",
                                "         --access-key ",
                                {
                                    "Ref": "AWSAccessKey"
                                },
                                "         --secret-key ",
                                {
                                    "Ref": "AWSSecretKey"
                                },
                                " || error_exit 'Failed to run cfn-init'\n",
                                "# Fixup path and links for the bootstrap script\n",
                                "export PATH=$PATH:/var/lib/gems/1.8/bin\n",
                                "mkdir -p /var/log/chef /var/lib/chef /var/cache/chef /var/backups/chef /var/run/chef\n",
                                "chef-client -d -j /etc/chef/roles.json -L /var/log/chef/client.log -i 1800 -s 20 -N cadmium-`curl http://169.254.169.254/latest/meta-data/instance-id`\n"
                            ]
                        ]
                    }
                }
            }, 
            "Type": "AWS::EC2::Instance"
        }, 
        "CadmiumSecurityGroup": {
            "Description": "The security group that all of the Cadmium Nodes belong to.",
            "Properties": {
                "GroupDescription": "A group that allows the load balancer to talk to the cadmium nodes."
            }, 
            "Type": "AWS::EC2::SecurityGroup"
        },
        "CadmiumClusterIngress": {
            "Type": "AWS::EC2::SecurityGroupIngress",
            "Description": "Addes TCP access for all EC2 Resources belonging to the CadmiumSecurityGroup.  This is required to cluster.",
            "Properties": {
              "GroupId" : {"Ref" : "CadmiumSecurityGroup" }
              "IpProtocol" : "TCP",
              "SourceSecurityGroupId" : { "Ref": "CadmiumSecurityGroup" },
              "FromPort" : 0,
              "ToPort" : 65535
            }
        },
        "CadmiumWildcardCName": {
            "Description": "The wildcard CNAME record for deployed applications.", 
            "Properties": {
                "HostedZoneId": "/hostedzone/ZCD7YP7AJKBS4", 
                "Name": {
                    "Fn::Join": [
                        "", 
                        [
                            "\\052.", 
                            {
                                "Ref": "Host"
                            }, 
                            "."
                        ]
                    ]
                }, 
                "ResourceRecords": [
                    {
                        "Ref": "CadmiumELB"
                    }
                ], 
                "TTL": "20", 
                "Type": "CNAME"
            }, 
            "Type": "AWS::Route53::RecordSet"
        }
    }
}
